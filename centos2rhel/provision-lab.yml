- name: This play provisions loadbalancer VM for control plane
  hosts: localhost
  vars:
    network_cidr: 192.168.215.0/24
  tasks:
    - name: Provision all terraform resources
      community.general.terraform:
        project_path: "terraform/"
        force_init: true
        variables:
          network_cidr: ' ["{{ network_cidr }}"]'
        state: present

    - name: Add Local resolver for the domain
      copy:
        content: server=/rhdemo.labs/{{ network_cidr }}
        dest: /etc/NetworkManager/dnsmasq.d/rhdemo.conf
        state: present
      become: true
    
    - name: Restart NetworkManager to reload config
      service:
        name: NetworkManager
        state: restarted

    - name: Add servers to inventory
      add_host:
        hostname: "{{ item }}.{{ domain }}"
        ansible_user: sysadmin
        ansible_password: redhat
        groups:
          - "servers"        
      loop:
        - centos8-server
        - rhel8-server

    - name: Ensure to clean known_hosts
      known_hosts:
        host: "{{ item }}"
        path: ~/.ssh/known_hosts
        state: absent
      loop: "{{ groups['servers'] }}"

- name: Check connection to servers
  hosts: servers
  gather_facts: no
  tasks:
    - name: Waiting for installation to end, it can take time!
      wait_for_connection:
        timeout: 1800
        delay: 300

    - ping:

